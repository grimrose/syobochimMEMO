<!DOCTYPE html>




<html lang="en">
  <head>
    <meta charset="utf-8" />
    
    <title>クラスローダーとJ2EEパッケージング戦略を理解する &mdash; Wada_MEMO 2013.10.15 ドキュメント</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    
<link rel="stylesheet" href="../_static/css/basicstrap-base.css" type="text/css" />
<link rel="stylesheet" href="../_static/css/bootswatch-united.css" type="text/css" />
<link rel="stylesheet" href="../_static/css/font-awesome.min.css">
<!--[if IE 7]>
<link rel="stylesheet" href="../_static/css/font-awesome-ie7.min.css">
<![endif]-->
<style type="text/css">
  body {
    padding-top: 60px;
    padding-bottom: 40px;
  }
}
</style>
<link rel="stylesheet" href="../_static/basicstrap.css" type="text/css" />
<link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
<link rel="stylesheet" href="../_static/custom.css" type="text/css" />
<link rel="stylesheet" href="../_static/css/bootstrap-responsive.min.css" type="text/css" />
    
<script type="text/javascript">
  var DOCUMENTATION_OPTIONS = {
            URL_ROOT:    '../',
            VERSION:     '2013.10.15',
            COLLAPSE_INDEX: false,
            FILE_SUFFIX: '.html',
            HAS_SOURCE:  true
  };
</script>
<script type="text/javascript" src="../_static/js/jquery.min.js"></script>
<script type="text/javascript" src="../_static/underscore.js"></script>
<script type="text/javascript" src="../_static/doctools.js"></script>
<script type="text/javascript" src="../_static/translations.js"></script>
<script type="text/javascript" src="../_static/js/bootstrap.min.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    $('.show-sidebar').click(function(e) {
       e.preventDefault();
       if ($(".show-sidebar").html() == "Open Table Of Contents") {
          $('.for-mobile').removeClass('hidden-phone');
          $(".show-sidebar").html("Close Table Of Contents");
       } else {
          $(".show-sidebar").html("Open Table Of Contents");
       }
    });
  });
</script>
    <link rel="top" title="Wada_MEMO 2013.10.15 ドキュメント" href="../index.html" />
    <link rel="up" title="2013年下期 コア技術学習" href="2013_2H.html" />
    <link rel="next" title="J2EEパターン -明暗を分ける設計の戦略-(書籍)" href="2013_2H_03.html" />
    <link rel="prev" title="★WebSphere Application Server (WAS) 虎の巻" href="2013_2H_01.html" /> 
  </head>
  <body>
    <div class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="../index.html">Wada_MEMO 2013.10.15 ドキュメント</a>
          <div class="nav-collapse collapse">
            <ul class="nav pull-right">
              
                <li>
                <a href="../genindex.html" title="総合索引" accesskey="I">索引</a>
                </li>
                <li>
                <a href="2013_2H_03.html" title="J2EEパターン -明暗を分ける設計の戦略-(書籍)" accesskey="N">次へ</a>
                </li>
                <li>
                <a href="2013_2H_01.html" title="★WebSphere Application Server (WAS) 虎の巻" accesskey="P">前へ</a>
                </li>
                <li>
                <a href="../Core.html" >コア技術学習</a>
                </li>
                <li>
                <a href="2013_2H.html" accesskey="U">2013年下期　コア技術学習</a>
                </li>
              
            </ul>
          </div>
        </div>
      </div>
    </div>
    

    <!-- container -->
    <div class="container-fluid">


      
      <div class="row-fluid hidden-desktop hidden-tablet">
      
<div class="span3 ">
  <a class="visible-phone btn btn-small show-sidebar" data-toggle="collapse" data-target=".for-mobile">Open Table Of Contents</a>
  <div class="for-mobile sidebar hidden-phone">
  <h3><a href="../index.html">目次</a></h3>
  <ul>
<li><a class="reference internal" href="#">クラスローダーとJ2EEパッケージング戦略を理解する</a><ul>
<li><a class="reference internal" href="#id2">第1回 「クラスローダーを理解する - クラスはどこからやってきた？」</a></li>
<li><a class="reference internal" href="#id3">第2回「クラスローダーを理解する - シングルトンがシングルトンでなくなる日」</a></li>
<li><a class="reference internal" href="#id4">第3回「J2EEパッケージング戦略を理解する-恐怖のドッペルゲンガー」</a><ul>
<li><a class="reference internal" href="#j2ee-1">J2EEパッケージング戦略-モデル1</a></li>
<li><a class="reference internal" href="#j2ee-2">J2EEパッケージング戦略-モデル2</a></li>
<li><a class="reference internal" href="#id5">時間と空間 - トレードオフ</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id6">第4回「ディフェンシブ・パッケージング」</a></li>
<li><a class="reference internal" href="#id7">第5回「スレッド・コンテキストを理解する」</a><ul>
<li><a class="reference internal" href="#id8">方法1: クラス（クラス・ローダー）を明示的に渡す</a></li>
<li><a class="reference internal" href="#id9">方法2: コンテキスト・クラスローダーを用いる</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>前のトピックへ</h4>
  <p class="topless"><a href="2013_2H_01.html"
                        title="前の章へ">★WebSphere Application Server (WAS) 虎の巻</a></p>
  <h4>次のトピックへ</h4>
  <p class="topless"><a href="2013_2H_03.html"
                        title="次の章へ">J2EEパターン -明暗を分ける設計の戦略-(書籍)</a></p>
  <h3>このページ</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/Core/2013_2H_02.txt"
           rel="nofollow">ソースコードを表示</a></li>
  </ul>
<div id="searchbox">
  <h3>クイック検索</h3>
  <form class="search form-search" action="../search.html" method="get">
      <div class="input-append">
        <input type="text" class="search-query" name="q">
        <input type="submit" class="btn" value="検索" />
      </div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    モジュール、クラス、または関数名を入力してください
    </p>
</div>
  </div>
</div>
      </div>
      

      <!-- row -->
      <div class="row-fluid">
         
<div class="span3 visible-desktop visible-tablet">
  <div class=" sidebar hidden-phone">
  <h3><a href="../index.html">目次</a></h3>
  <ul>
<li><a class="reference internal" href="#">クラスローダーとJ2EEパッケージング戦略を理解する</a><ul>
<li><a class="reference internal" href="#id2">第1回 「クラスローダーを理解する - クラスはどこからやってきた？」</a></li>
<li><a class="reference internal" href="#id3">第2回「クラスローダーを理解する - シングルトンがシングルトンでなくなる日」</a></li>
<li><a class="reference internal" href="#id4">第3回「J2EEパッケージング戦略を理解する-恐怖のドッペルゲンガー」</a><ul>
<li><a class="reference internal" href="#j2ee-1">J2EEパッケージング戦略-モデル1</a></li>
<li><a class="reference internal" href="#j2ee-2">J2EEパッケージング戦略-モデル2</a></li>
<li><a class="reference internal" href="#id5">時間と空間 - トレードオフ</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id6">第4回「ディフェンシブ・パッケージング」</a></li>
<li><a class="reference internal" href="#id7">第5回「スレッド・コンテキストを理解する」</a><ul>
<li><a class="reference internal" href="#id8">方法1: クラス（クラス・ローダー）を明示的に渡す</a></li>
<li><a class="reference internal" href="#id9">方法2: コンテキスト・クラスローダーを用いる</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>前のトピックへ</h4>
  <p class="topless"><a href="2013_2H_01.html"
                        title="前の章へ">★WebSphere Application Server (WAS) 虎の巻</a></p>
  <h4>次のトピックへ</h4>
  <p class="topless"><a href="2013_2H_03.html"
                        title="次の章へ">J2EEパターン -明暗を分ける設計の戦略-(書籍)</a></p>
  <h3>このページ</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/Core/2013_2H_02.txt"
           rel="nofollow">ソースコードを表示</a></li>
  </ul>
<div id="searchbox">
  <h3>クイック検索</h3>
  <form class="search form-search" action="../search.html" method="get">
      <div class="input-append">
        <input type="text" class="search-query" name="q">
        <input type="submit" class="btn" value="検索" />
      </div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    モジュール、クラス、または関数名を入力してください
    </p>
</div>
  </div>
</div> 
        

        <div class="span9">
          <div class="document">
            <div class="documentwrapper">
              <div class="bodywrapper">
                <div class="body">
                  
  <div class="section" id="j2ee">
<h1><a class="toc-backref" href="#id10">クラスローダーとJ2EEパッケージング戦略を理解する</a><a class="headerlink" href="#j2ee" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="contents topic" id="id1">
<p class="topic-title first">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#j2ee" id="id10">クラスローダーとJ2EEパッケージング戦略を理解する</a><ul>
<li><a class="reference internal" href="#id2" id="id11">第1回 「クラスローダーを理解する - クラスはどこからやってきた？」</a></li>
<li><a class="reference internal" href="#id3" id="id12">第2回「クラスローダーを理解する - シングルトンがシングルトンでなくなる日」</a></li>
<li><a class="reference internal" href="#id4" id="id13">第3回「J2EEパッケージング戦略を理解する-恐怖のドッペルゲンガー」</a></li>
<li><a class="reference internal" href="#id6" id="id14">第4回「ディフェンシブ・パッケージング」</a></li>
<li><a class="reference internal" href="#id7" id="id15">第5回「スレッド・コンテキストを理解する」</a></li>
</ul>
</li>
</ul>
</div>
<div class="line-block">
<div class="line">下記サイトを参照して学習を実施。</div>
<div class="line"><a class="reference external" href="http://www.ibm.com/developerworks/jp/websphere/library/java/j2ee_classloader/">http://www.ibm.com/developerworks/jp/websphere/library/java/j2ee_classloader/</a></div>
<div class="line"><br /></div>
</div>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id11">第1回 「クラスローダーを理解する - クラスはどこからやってきた？」</a><a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="line-block">
<div class="line"><br /></div>
<div class="line">WebSphere Application Server内でのクラスローダー構成</div>
</div>
<img alt="../_images/02_1_1.gif" src="../_images/02_1_1.gif" />
<div class="line-block">
<div class="line"><br /></div>
<div class="line">クラスローダーを理解するうえで最も重要な概念は、「デリゲーションモデル」です。クラスローダーは、必要に応じて親クラスローダーにクラスのロードをお願い、つまりお任せ、委譲（デリゲート）するのです。</div>
<div class="line"><br /></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p class="last">デリゲーションモデルで重要なことは、決して子供にお願いすることはないということです。上にたどることはあっても、下を探すことはありません。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id3">
<h2><a class="toc-backref" href="#id12">第2回「クラスローダーを理解する - シングルトンがシングルトンでなくなる日」</a><a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="line-block">
<div class="line"><br /></div>
<div class="line">クラスローダーのうち、アプリケーション・クラスローダーとWARクラスローダーについては、デリゲーション・モードをカスタマイズすることが可能です。</div>
<div class="line">デリゲーション・モードの設定は2種類です。</div>
<div class="line">「PARENT FIRST（親が最初）」と「PARENT LAST（親が最後）」です。</div>
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>「PARENT FIRST（親が最初）」（デフォルト値）の場合 自クラスローダーのローカル・クラスパスを探す前に、最初に親クラスローダーにデリゲートします。親で見つからなかったときにはじめて、自分のローカル・クラスパスを探しに行きます。</li>
<li>「PARENT LAST（親が最後）」の場合 自クラスローダーのローカル・クラスパスを最初に探します。見つからなかったときにはじめて、親クラスローダーにデリゲートします。</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
<div class="line">デリゲーション・モードの設定によってクラスを探す順番が変わってきます。WARクラスローダーがあるクラスをロードする場合、表1に示す順番で各クラスローダーがクラスを探すことになります。</div>
<div class="line"><br /></div>
</div>
<img alt="../_images/02_1_1.gif" src="../_images/02_1_1.gif" />
<div class="line-block">
<div class="line"><br /></div>
</div>
<img alt="../_images/02_2_8.gif" src="../_images/02_2_8.gif" />
<div class="line-block">
<div class="line"><br /></div>
<div class="line">例えば、デフォルト値である「（A）APP-FIRST、WAR-FIRST」、すなわち、アプリケーション・クラスローダー、WARクラスローダーどちらも「PARENT FIRST」の場合は、探す順番はクラスローダー・ツリーの上から下へ単純に降りてくることになります。</div>
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">ノート</p>
<p class="last">Java基本クラスローダーが担当するコアクラス（java.lang.*など）に関しては、たとえ「PARENT LAST」にしても、「上書き」できません。これはJavaのセキュリティー・モデルで禁止されています。これを許すと、攻撃者に内部攻撃の機会を与えてしまうことになります。例えば、java.lang.String等を勝手に書き換えられたら、java.lang.Stringの不変性に依存しているクラスなどは、その前提が破壊されていまうことになり、重大なセキュリティー・リスクを背負うことになります。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id4">
<h2><a class="toc-backref" href="#id13">第3回「J2EEパッケージング戦略を理解する-恐怖のドッペルゲンガー」</a><a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="line-block">
<div class="line"><br /></div>
<div class="line">J2EEパッケージング戦略の基本方針は、J2EE仕様に準拠した「どんなアプリケーション・サーバーでも通用するポータブルなEAR」を作成すること。</div>
<div class="line">そのためのルール</div>
</div>
<ol class="arabic simple">
<li>EARは独立・自己完結したアプリケーションのパッケージング単位です。EARひとつを渡せば全て済むというのが、正しいEARの姿です。EAR以外のライブラリーが別途必要だったり、アプリケーション・サーバー特有のクラスパスの修正を要求したりするようなEARは、「不完全なEAR」とみなして毛嫌いしましょう。</li>
<li>クラスローダー・デリゲーションモードの設定は、アプリケーション・クラスローダー、各WARクラスローダー、共に「PARENT LAST（親が最後）」に設定します。</li>
<li>クラスローダー・ポリシー（アイソレーション・モード）の設定は、デフォルト設定をそのまま使用します。アプリケーションごとにアプリケーション・クラスローダーが1つ、さらに下位クラスローダーとして、WARごとに専用のWARクラスローダーが1つずつ割り当てられる設定です。決して「パッケージングについてあまり考えたくない」という理由だけで、後先のことを考えずに「単数（シングル）」や「アプリケーション」等に変更しないでください。「ダークサイド」に落ちてはいけません。</li>
</ol>
<div class="line-block">
<div class="line"><br /></div>
<div class="line">それによるメリット</div>
</div>
<ol class="arabic simple">
<li>自己完結EARのためサーバー環境からの影響を受けにくい</li>
<li>ライブラリーの可視範囲を最小限におさえることができるためクラス汚染を防げる</li>
</ol>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
<div class="section" id="j2ee-1">
<h3>J2EEパッケージング戦略-モデル1<a class="headerlink" href="#j2ee-1" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="line-block">
<div class="line">一例です。</div>
<div class="line"><br /></div>
<div class="line"><strong>図1 モジュール・ライブラリー依存関係</strong></div>
</div>
<img alt="../_images/02_3_1.gif" src="../_images/02_3_1.gif" />
<div class="line-block">
<div class="line"><br /></div>
<div class="line">WARひとつの場合と同様に、各WAR内部に使用するライブラリーを全て入れておきます。さらに、EARの直下にも使用ライブラリーを配置しています。</div>
</div>
<div class="highlight-python"><pre>luv-app.ear
  - META-INF/application.xml
  - ejb1.jar
  - ejb2.jar
  - utility.jar
  - commons-xxx.jar
  - luv1.war
      - WEB-INF/lib
        - utility.jar
        - commons-xxx.jar
        - struts.jar
  - luv2.war
      - WEB-INF/lib
        - utility.jar
        - commons-xxx.jar
        - struts.jar
  - luv3.war
      - WEB-INF/lib
        - commons-xxx.jar
        - struts.jar
        - web-util.jar</pre>
</div>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><strong>図2 クラスローダーの観点から見た場合 - Missing library？</strong></div>
</div>
<img alt="../_images/02_3_2.gif" src="../_images/02_3_2.gif" />
<div class="line-block">
<div class="line"><br /></div>
<div class="line">図2は、クラスローダーの観点から見た場合、各モジュール・ライブラリーがどのように配置されるかを示したものです。</div>
<div class="line">utility.jar等に依存しているEJBモジュールは、このままでは正常に動作しないことがわかるでしょう。EJBモジュールはutility.jarを発見できません。</div>
<div class="line">下位クラスローダーである各WARクラスローダー内は、クラス検索の対象にならないからです。</div>
<div class="line"><br /></div>
<div class="line"><br /></div>
<div class="line">そこで、パッケージングを行う際は、使用する依存ライブラリーをJ2EEコンテナに教えてあげる必要があります。</div>
<div class="line">今回の例では、EJBモジュール・ejb1.jarは、utility.jar等に依存しています。そこで、このEJBモジュール内部の、マニフェスト・ファイル「META-INF/MANIFEST.MF」に使用するライブラリーを宣言しておきます。</div>
<div class="line"><br /></div>
<div class="line"><strong>ejb1.jar内のMETA-INF/MANIFEST.MFの内容</strong></div>
</div>
<div class="highlight-python"><pre>Manifest-Version: 1.0
Class-Path: utility.jar
 commons-xxx.jar
 commons-yyy.jar
 commons-zzz.jar</pre>
</div>
<div class="line-block">
<div class="line"><br /></div>
<div class="line">マニフェスト・ファイルの「Class-Path」エントリーがライブラリー発見メカニズムです。</div>
<div class="line">J2EEコンテナは、J2EEモジュール、すなわちWAR、ejb-jar内のマニフェスト・ファイルにClass-Pathエントリーがあった場合、そこに宣言されているライブラリーを、アプリケーション・クラスローダー配下に配置します。</div>
<div class="line">Class-Pathエントリーに記述するパスは、EARのトップからの相対位置で指定します。</div>
<div class="line">EAR内に同梱され、J2EEモジュールから使用されるライブラリーのことを、J2EE仕様では「Bundled Optional Package」と呼んでいます。</div>
<div class="line"><br /></div>
<div class="line"><strong>図3 クラスローダーの観点から見た場合 - Bundled Optional Packageの可視化</strong></div>
</div>
<img alt="../_images/02_3_3.gif" src="../_images/02_3_3.gif" />
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<div class="last line-block">
<div class="line">WARに含まれているクラスを、別のWARやJARの中から使用しようとしないでください。このように、luv2.warへの参照を明記しても、luv2.war内のクラスが見えるようにはなりません。WARはあくまで、Web「アプリケーション」であって、「ライブラリー」ではないのです。他から使用するようものではありません。</div>
<div class="line">そもそも、WARはライブラリー「Jar」ではないのです。確かにWARの物理的なファイル・フォーマットは「Jar」ですが、論理的なパッケージング構造は「Jar」ではありません。「Jar」がライブラリーとして正しく機能するためには、Javaのパッケージ階層構造がそのまま「Jar」内部のディレクトリー構造と一致する必要があります。そういう意味では、EJBモジュールは、「Jar」です。Javaのパッケージ階層構造がそのままJarとしてパッケージングされているからです。</div>
<div class="line">「あるWARに含まれているクラスを、別のWARでも使用したくなった」[注]というのはよいメッセージです。そのクラスが「ある1つのWebアプリケーション特有」ではないということを教えてくれています。そのクラスは、別途ユーティリティーJarとしてライブラリー化した方がよいでしょう。</div>
</div>
</div>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="j2ee-2">
<h3>J2EEパッケージング戦略-モデル2<a class="headerlink" href="#j2ee-2" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="highlight-python"><pre>luv-app.ear
  - META-INF/application.xml
  - ejb1.jar
  - ejb2.jar
  - utility.jar
  - commons-xxx.jar
  - struts.jar
  - luv1.war
  - luv2.war
  - luv3.war
      - WEB-INF/lib
        - web-util.jar</pre>
</div>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
<img alt="../_images/02_3_4.gif" src="../_images/02_3_4.gif" />
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="admonition note">
<p class="first admonition-title">ノート</p>
<p class="last">マニフェスト・ファイルの修正を忘れないでください。</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id5">
<h3>時間と空間 - トレードオフ<a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="line-block">
<div class="line"><br /></div>
<div class="line">モデル1では、各WARの独立性が高まります。</div>
<div class="line">あるWAR内でのライブラリーの変更は、他のWARへ影響を与えません。</div>
<div class="line"><br /></div>
<div class="line">モデル2では、ライブラリーは一箇所に置かれるため、ライブラリーの管理は容易になります。</div>
<div class="line">また、ランタイム時、若干ではありますがリソースの節約にもつながります。</div>
<div class="line">その反面、EAR内の全てのWARにそのライブラリーは公開されるというリスクを背負うことにもなります。</div>
<div class="line"><br /></div>
<div class="line">モデル1、モデル2のどちらがよいかは、むしろ、ライブラリーごとに決定するべき問題といえる。</div>
<div class="line"><br /></div>
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="id6">
<h2><a class="toc-backref" href="#id14">第4回「ディフェンシブ・パッケージング」</a><a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="line-block">
<div class="line"><br /></div>
<div class="line">commons-loggingについての実際の例にて説明</div>
<div class="line"><a class="reference external" href="http://www.ibm.com/developerworks/jp/websphere/library/java/j2ee_classloader/4.html">http://www.ibm.com/developerworks/jp/websphere/library/java/j2ee_classloader/4.html</a></div>
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id7">
<h2><a class="toc-backref" href="#id15">第5回「スレッド・コンテキストを理解する」</a><a class="headerlink" href="#id7" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="line-block">
<div class="line"><br /></div>
<div class="line">プロパティの読み込みを行うユーティリティクラスPropertiesUtilも、ユーティリティJAR(utility.jar)の中にいれて、EAR内にひとつだけ置くことにしました。</div>
</div>
<img alt="../_images/02_5_2.gif" src="../_images/02_5_2.gif" />
<div class="line-block">
<div class="line"><br /></div>
<div class="line">今回（図2）のケースでは、PropertiesUtilクラスは、アプリケーションクラスローダー配下にあります。</div>
<div class="line">そのため、この箇所で取得・使用されるクラスローダーは、クラス「Class&lt;PropertiesUtil&gt;」をロードしたクラスローダー、すわわちアプリケーションクラスローダーです。</div>
<div class="line">親クラスローダーであるアプリケーションクラスローダーは、子クラスローダー配下に存在するプロパティファイルを見つけることはできません。</div>
<div class="line"><br /></div>
<div class="line">今回のようなケース、すなわち</div>
</div>
<ul class="simple">
<li>共通ユーティリティクラス、いわゆる「ライブラリ」は親クラスローダー配下に存在</li>
<li>ライブラリを利用するクライアント、すなわちアプリケーションのクラスは子クラスローダー配下に存在</li>
</ul>
<div class="line-block">
<div class="line">というのは、Java EEの世界に限った話ではなく、Javaでは非常によくある形態です。</div>
<div class="line">このような場合に、ライブラリ側から、クライアント側であるアプリケーション内のリソースを取得するにはどうすればよいでしょうか？</div>
<div class="line"><br /></div>
</div>
<div class="section" id="id8">
<h3>方法1: クラス（クラス・ローダー）を明示的に渡す<a class="headerlink" href="#id8" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="line-block">
<div class="line"><br /></div>
<div class="line">「ライブラリ側が、クライアント側のクラスローダーを、なんらかの方法で取得できればよい」のですから、まず最初に思いつく方法として、「リソースの読み込みに使用するクラスローダーを、ライブラリ側がクライアントから明示的に受け取る」ことが考えられます。</div>
<div class="line">この場合は、クライアント側はリスト7のようになります。クラスローダーを直接受け渡してもよいですが、ここではクライアント側の自クラスをライブラリ側に渡すことにします。</div>
<div class="line"><br /></div>
<div class="line"><strong>リスト7: クライアント側 - クラスを明示的に渡す</strong></div>
</div>
<div class="highlight-python"><pre>public class MyPojo {
  PropertiesUtil propUtils = ...; // get instance

  void init() {
      Properties props = propUtils.getProperties("module.properties", getClass());
      ...
  }</pre>
</div>
<div class="line-block">
<div class="line"><br /></div>
<div class="line">ライブラリ側では、渡されたクラスからクラスローダーを取得、リソースの読み込みに使用します（リスト8）。</div>
<div class="line"><br /></div>
<div class="line"><strong>リスト8: ライブラリ側 - 渡されたクラスからクラスローダーを取得して使用</strong></div>
</div>
<div class="highlight-python"><pre>public class PropertiesUtil {

  public void Properties getProperties(String name, Class&lt;?&gt; clazz) {
      ClassLoader cl = clazz.getClassLoader();
      InputStream is = cl.getResourceAsStream(name);
      ...
  }</pre>
</div>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id9">
<h3>方法2: コンテキスト・クラスローダーを用いる<a class="headerlink" href="#id9" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="line-block">
<div class="line"><br /></div>
<div class="line">鍵となるのは、「スレッド・コンテキスト」です。リスト9をご覧ください。</div>
<div class="line"><br /></div>
<div class="line"><strong>リスト9: コンテキスト・クラスローダーを用いる</strong></div>
</div>
<div class="highlight-python"><pre>public class PropertiesUtil {

  public void Properties getProperties(String name) {
      ClassLoader cl = Thread.currentThread().getContextClassLoader();
      InputStream is = cl.getResourceAsStream(name);
      ...
  }</pre>
</div>
<div class="line-block">
<div class="line"><br /></div>
<div class="line">現在のスレッド（Thread.currentThread()）にセットされている「コンテキスト・クラスローダー」を取得しています。</div>
<div class="line">方法1のように明示的にクラスやクラスローダーを受け取ることなく、「現在の呼び出し側」のクラスローダーを取得することが可能です。</div>
<div class="line"><br /></div>
<div class="line">Java EEの世界ではどのようにコンテキスト・クラスローダーが決定されるのでしょうか？</div>
<div class="line"><br /></div>
<div class="line">実例で理解するため、図3に示すEARを取り上げます。このEARを用いた場合、PropertyUtilsまでの呼び出しシーケンスと、その結果、クラスPropertyUtils内で取得できるコンテキスト・クラスローダーの対応を表1に示します。</div>
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
<img alt="../_images/02_5_3.gif" src="../_images/02_5_3.gif" />
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p class="last">スレッド・コンテキストが変化するのは、サーブレットやEJB等のJava EEのコンポーネントを「正式に」呼び出した時、すなわち、HTTPリクエストを受けてサーブレットの処理が始まったときや、EJBコールを行ったときになります。ケース5のように、EJB JAR内の含まれるクラス「MyPojoInEJBJar」を単に経由するだけでは、スレッド・コンテキストが変わることはありません。この場合は、コンテキスト・クラスローダーはWARクラスローダーのまま変化しないことにご注意ください。</p>
</div>
</div>
</div>
</div>


                </div>
              </div>
            </div>
          </div>
        </div>
        
        
      </div><!-- /row -->

      <!-- row -->
      <div class="row-fluid">
<div class="related navbar ">
  <div class="navbar-inner">
    <ul class="nav pull-right">
      
        <li><a href="../genindex.html" title="総合索引" >索引</a></li>
        <li><a href="2013_2H_03.html" title="J2EEパターン -明暗を分ける設計の戦略-(書籍)" >次へ</a></li>
        <li><a href="2013_2H_01.html" title="★WebSphere Application Server (WAS) 虎の巻" >前へ</a></li>
        <li><a href="../index.html">Wada_MEMO 2013.10.15 ドキュメント</a></li>
        <li><a href="../Core.html" >コア技術学習</a></li>
        <li><a href="2013_2H.html" >2013年下期　コア技術学習</a></li> 
      
    </ul>
  </div>
</div>
      </div><!-- /row -->

      <!-- footer -->
      <footer>
          &copy; Copyright 2013, Mizuki Wada.
        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2b2.
      </footer>
      <!-- /footer -->

    </div>
    <!-- /container -->

  </body>
</html>